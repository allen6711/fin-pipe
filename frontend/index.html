<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Smart Accounting - Redesigned</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- Global & Base Styles --- */
    :root {
      --primary-accent: #4facfe;
      --secondary-accent: #00f2fe;
      --text-light: #ffffff;
      --text-dark: #2d3748;
      --bg-glass: rgba(255, 255, 255, 0.1);
      --border-color: rgba(255, 255, 255, 0.2);
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-light);
    }

    /* --- Animated Particle Background --- */
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0); opacity: 1; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 0.7; }
    }

    /* --- Main Container --- */
    .container {
      max-width: 600px;
      width: 100%;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--border-color);
      padding: 40px;
      box-shadow: 0 8px 32px var(--shadow-color);
      transition: all 0.3s ease;
    }

    /* --- UI Components --- */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.25rem;
      font-weight: 700;
    }
    .header p {
      font-size: 1rem;
      opacity: 0.8;
      margin-top: 8px;
    }

    .btn {
      display: inline-block;
      padding: 12px 28px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-light);
      background: linear-gradient(135deg, var(--primary-accent) 0%, var(--secondary-accent) 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    .btn:disabled {
        background: #999;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-secondary {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid var(--border-color);
        box-shadow: none;
    }
     .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* --- Step 1: Upload --- */
    #step-1-upload .drop-area {
      border: 2px dashed var(--border-color);
      border-radius: 16px;
      padding: 50px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #step-1-upload .drop-area.drag-over {
      border-color: var(--secondary-accent);
      background: rgba(0, 242, 254, 0.1);
    }
    .drop-area-icon {
      font-size: 3rem;
      color: var(--secondary-accent);
    }
    .drop-area-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 15px;
    }
    .drop-area-hint {
      opacity: 0.7;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    #csvFile { display: none; }
    
    /* --- Step 2: Categorize --- */
    .payee-list {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px; /* for scrollbar */
    }
    .payee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    .payee-item-label {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 15px;
    }
    .action-bar {
      margin-top: 30px;
      text-align: center;
    }
    
    /* --- Custom Select Dropdown --- */
    .custom-select-wrapper {
        position: relative;
        width: 160px;
    }
    .custom-select {
        background: rgba(0,0,0,0.2);
        color: var(--text-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: border-color 0.2s;
    }
    .custom-select.open {
        border-color: var(--primary-accent);
    }
    .custom-select-arrow {
        transform: rotate(0deg);
        transition: transform 0.2s;
    }
    .custom-select.open .custom-select-arrow {
        transform: rotate(180deg);
    }
    .custom-options {
        position: absolute;
        top: 105%;
        left: 0;
        right: 0;
        background: rgba(40, 45, 80, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        transform-origin: top;
        animation: scaleIn 0.2s ease-out;
    }
    @keyframes scaleIn {
        from { opacity: 0; transform: scaleY(0.8); }
        to { opacity: 1; transform: scaleY(1); }
    }
    .custom-options.show {
        display: block;
    }
    .custom-option {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .custom-option:hover {
        background-color: rgba(79, 172, 254, 0.3);
    }
    .custom-option.selected {
        background-color: var(--primary-accent);
        font-weight: 600;
    }

    /* --- Step 3: Success --- */
    .success-container {
      text-align: center;
    }
    .success-icon {
      font-size: 4rem;
    }
    .success-title {
      font-size: 1.75rem;
      font-weight: 600;
      margin-top: 15px;
    }
    .success-message {
      opacity: 0.9;
      margin-top: 8px;
      font-size: 1.1rem;
    }
    
    /* --- Loading Spinner --- */
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-left-color: #fff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 40px auto;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
<div class="bg-particles"></div>
<div class="container" id="main-container">
  </div>

<script>
// --- Global Variables ---
const mainContainer = document.getElementById("main-container");
let csvPath = "";
let payees = [];
const categories = [
    { value: '01_Dining', label: 'Dining' },
    { value: '02_Clothing', label: 'Clothing' },
    { value: '03_Housing', label: 'Housing' },
    { value: '04_Furniture', label: 'Furniture' },
    { value: '05_Transportation', label: 'Transportation' },
    { value: '06_Vehicles', label: 'Vehicles' },
    { value: '07_Daily Necessities', label: 'Daily Necessities' },
    { value: '08_Gift', label: 'Gift' },
    { value: '09_Health', label: 'Health' },
    { value: '10_Education', label: 'Education' },
    { value: '11_Entertainment', label: 'Entertainment' },
    { value: '12_Travel', label: 'Travel' },
    { value: '13_Service', label: 'Service' },
    { value: '14_Others', label: 'Others' }
];

// --- Initial Load ---
document.addEventListener("DOMContentLoaded", () => {
  createParticles();
  renderStep1();
});

// --- Render Functions ---
function renderStep1() {
  mainContainer.innerHTML = `
    <div id="step-1-upload" class="fade-in">
      <div class="header">
        <h1>‚ú® AI Smart Accounting</h1>
        <p>Upload your bank CSV statement and let us categorize it for you</p>
      </div>
      <div class="drop-area" id="dropArea">
        <div class="drop-area-icon">üì§</div>
        <div class="drop-area-text" id="dropAreaText">Click here or drag & drop a file to upload</div>
        <div class="drop-area-hint">Only .csv files are accepted</div>
      </div>
      <input type="file" id="csvFile" accept=".csv">
    </div>
  `;
  setupStep1Listeners();
}

function renderStep2() {
  const optionsHTML = categories.map(cat => 
    `<div class="custom-option" data-value="${cat.value}">${cat.label}</div>`
  ).join('');

  let payeeItemsHTML = payees.map(p => {
    // ÁÇ∫‰∫ÜÂÆâÂÖ®ÔºåÂ∞ç payee ÈÄ≤Ë°åÁ∑®Á¢ºÔºå‰ΩøÂÖ∂ËÉΩË¢´ÂÆâÂÖ®Âú∞ÊîæÂÖ• HTML Â±¨ÊÄß‰∏≠
    const encodedPayee = p.replace(/"/g, '&quot;');
    return `
    <div class="payee-item">
      <div class="payee-item-label" title="${encodedPayee}">${p}</div>
      
      <div class="custom-select-wrapper" data-payee="${encodedPayee}">
        <input type="hidden" value="${categories[0].value}">
        <div class="custom-select" tabindex="0">
          <span class="custom-select-trigger">${categories[0].label}</span>
          <div class="custom-select-arrow">‚ñæ</div>
        </div>
        <div class="custom-options">${optionsHTML}</div>
      </div>
    </div>
  `}).join("");

  mainContainer.innerHTML = `
    <div id="step-2-categorize" class="fade-in">
      <div class="header">
        <h1>Categorize Payees</h1>
        <p>Assign an accounting category for each payee</p>
      </div>
      <div class="payee-list" id="payeeContainer">
        ${payeeItemsHTML}
      </div>
      <div class="action-bar">
        <button id="submitBtn" class="btn">Submit Categories</button>
      </div>
    </div>
  `;
  setupStep2Listeners();
}

function renderLoading(message) {
    mainContainer.innerHTML = `
        <div class="fade-in" style="text-align: center;">
            <div class="header">
                <h1>Processing...</h1>
                <p>${message}</p>
            </div>
            <div class="spinner"></div>
        </div>
    `;
}

function renderStep3(result) {
  mainContainer.innerHTML = `
    <div id="step-3-success" class="fade-in">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <div class="success-title">Process Complete!</div>
            <p class="success-message">Successfully wrote ${result.rows_written} records to Google Sheets!</p>
            <div class="action-bar">
                <button id="restartBtn" class="btn btn-secondary">Upload Another File</button>
            </div>
        </div>
    </div>
  `;
  setupStep3Listeners();
}


// --- Event Listener Setup ---
function setupStep1Listeners() {
  const dropArea = document.getElementById("dropArea");
  const fileInput = document.getElementById("csvFile");
  
  dropArea.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => handleFile(e.target.files[0]));

  dropArea.addEventListener("dragover", (e) => { e.preventDefault(); dropArea.classList.add("drag-over"); });
  dropArea.addEventListener("dragleave", () => { dropArea.classList.remove("drag-over"); });
  dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropArea.classList.remove("drag-over");
    handleFile(e.dataTransfer.files[0]);
  });
}

function setupStep2Listeners() {
    document.getElementById("submitBtn").addEventListener("click", submitCategories);

    const wrappers = document.querySelectorAll('.custom-select-wrapper');
    
    wrappers.forEach(wrapper => {
        const select = wrapper.querySelector('.custom-select');
        const options = wrapper.querySelector('.custom-options');
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        const trigger = wrapper.querySelector('.custom-select-trigger');

        select.addEventListener('click', (e) => {
            e.stopPropagation();
            // Close all other dropdowns
            document.querySelectorAll('.custom-options.show').forEach(open_opt => {
                if(open_opt !== options) {
                    open_opt.classList.remove('show');
                    open_opt.previousElementSibling.classList.remove('open');
                }
            });
            // Toggle current dropdown
            options.classList.toggle('show');
            select.classList.toggle('open');
        });

        options.querySelectorAll('.custom-option').forEach(option => {
            option.addEventListener('click', () => {
              trigger.textContent = option.textContent;
              hiddenInput.value = option.dataset.value;

              // Ê∏ÖÈô§‰πãÂâçÁöÑÈÅ∏ÂèñÁãÄÊÖã
              options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
              option.classList.add('selected');

              options.classList.remove('show');
              select.classList.remove('open');
            });
        });
    });

    // Close dropdowns when clicking outside
    window.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select-wrapper')) {
            document.querySelectorAll('.custom-options.show').forEach(open_opt => {
                open_opt.classList.remove('show');
                open_opt.previousElementSibling.classList.remove('open');
            });
        }
    });
}

function setupStep3Listeners() {
    document.getElementById("restartBtn").addEventListener("click", renderStep1);
}

// --- Core Logic Functions ---
async function handleFile(file) {
  if (!file || !file.type.match('text/csv')) {
    alert("Please select a .csv file!");
    return;
  }
  
  renderLoading("Analyzing your CSV file...");

  const formData = new FormData();
  formData.append("file", file);
  
  try {
    const res = await fetch("http://localhost:5050/upload_csv", { method: "POST", body: formData });
    if (!res.ok) throw new Error(`Server error: ${res.statusText}`);
    const data = await res.json();
    csvPath = data.csv_path;
    payees = data.payees;
    renderStep2();
  } catch (error) {
    console.error("Upload failed:", error);
    alert(`File upload failed: ${error.message}. Please ensure your backend server is running.`);
    renderStep1(); 
  }
}

async function submitCategories() {
  renderLoading("Writing data to Google Sheets...");

  const mapping = {};
  
  // ‚úÖ ÈóúÈçµ: ÈÄôË£°ÁöÑÈÅ∏ÊìáÂô®‰πüÂøÖÈ†àÊòØ '.custom-select-wrapper'ÔºåÂÖ©ËÄÖÂøÖÈ†àÂÆåÂÖ®ÂåπÈÖç
  const wrappers = document.querySelectorAll('.custom-select-wrapper');
  
  wrappers.forEach(wrapper => {
      const payee = wrapper.dataset.payee; // Âæû data-payee Â±¨ÊÄßËÆÄÂèñ
      const value = wrapper.querySelector('input[type="hidden"]').value;
      
      if (payee) {
          mapping[payee] = value;
      }
  });

  // ÁèæÂú®ÈÄôÂÄã log ÊáâË©≤ËÉΩÊ≠£Á¢∫È°ØÁ§∫ÊÇ®ÈÅ∏ÊìáÁöÑÂÖßÂÆπ
  console.log("üîç Mapping sent to backend:", mapping);

  try {
    const res = await fetch("http://localhost:5050/submit_categories", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({mapping, csv_path: csvPath})
    });
    if (!res.ok) {
        // ÂòóË©¶Ëß£ÊûêÂæåÁ´ØÈåØË™§Ë®äÊÅØ
        const errorData = await res.json().catch(() => ({error: res.statusText}));
        throw new Error(`Server error: ${errorData.error || res.statusText}`);
    }
    const result = await res.json();
    renderStep3(result);
  } catch (error) {
    console.error("Submission failed:", error);
    alert(`Category submission failed: ${error.message}. Please ensure your backend server is running correctly.`);
    renderStep2();
  }
}


function createParticles() {
  const container = document.querySelector('.bg-particles');
  if (container.children.length > 0) return; 
  for (let i = 0; i < 40; i++) {
    const p = document.createElement('div');
    p.classList.add('particle');
    const size = Math.random() * 6 + 2;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.left = Math.random() * 100 + '%';
    p.style.top = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 6 + 's';
    container.appendChild(p);
  }
}

</script>
</body>
</html>
